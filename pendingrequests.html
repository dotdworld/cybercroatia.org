<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CyberCroatia – Admin Pending</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:#0b0d10;color:#e5e7eb;margin:0;padding:20px}
    .wrap{max-width:900px;margin:0 auto}
    .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:16px;margin:12px 0}
    .meta{font-size:12px;color:#9ca3af}
    code{color:#93c5fd}
    button{cursor:pointer;border:1px solid #374151;background:#1f2937;color:#e5e7eb;padding:8px 12px;border-radius:8px}
    button:hover{background:#374151}
    input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#111827;color:#e5e7eb}
    .row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Pending IOC review</h2>

    <div class="card">
      <div class="row">
        <input id="token" placeholder="ADMIN_TOKEN" />
        <button id="save">Save token</button>
        <button id="reload">Reload</button>
      </div>
      <div class="meta">Token se čuva u localStorage. Review pozivi idu na tvoj Worker: <code>/review</code> (POST).</div>
    </div>

    <div id="list"></div>
  </div>

  <script>
    const PENDING_URL = "data/pending.json"; // isti repo
    const REVIEW_ENDPOINT = "/review";       // tvoj Worker iza iste domene/proxyja

    const tokenInput = document.getElementById("token");
    const listEl = document.getElementById("list");

    document.getElementById("save").onclick = () => {
      localStorage.setItem("ADMIN_TOKEN", tokenInput.value.trim());
      alert("Saved.");
    };
    document.getElementById("reload").onclick = () => load();

    tokenInput.value = localStorage.getItem("ADMIN_TOKEN") || "";

    async function load() {
      listEl.innerHTML = "Loading…";
      const r = await fetch(PENDING_URL + "?t=" + Date.now(), { cache: "no-store" });
      if (!r.ok) { listEl.innerHTML = "Failed to load pending."; return; }
      const arr = await r.json().catch(()=>[]);
      const items = [];
      for (const rec of (Array.isArray(arr)?arr:[])) {
        for (const it of (rec.items || [])) items.push({ ...it, submittedAt: rec.submittedAt });
      }
      if (!items.length) { listEl.innerHTML = "<div class='card'>No pending items.</div>"; return; }

      listEl.innerHTML = items.map(it => `
        <div class="card">
          <div class="meta">${it.submittedAt || ""} · ${it.type?.toUpperCase() || ""}</div>
          <div><code>${escapeHtml(it.value || "")}</code></div>
          ${it.description ? `<div class="meta">Desc: ${escapeHtml(it.description)}</div>`:""}
          ${it.reputation ? `<div class="meta">VT: ${escapeHtml(it.reputation)}</div>`:""}
          <div class="row" style="margin-top:10px">
            <button onclick="act('${it.itemId}','approve')">✅ Approve</button>
            <button onclick="act('${it.itemId}','deny')">❌ Deny</button>
          </div>
        </div>
      `).join("");
    }

    async function act(itemId, action) {
      const token = (localStorage.getItem("ADMIN_TOKEN") || "").trim();
      if (!token) { alert("Set ADMIN_TOKEN first."); return; }
      const r = await fetch(REVIEW_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Admin-Token": token
        },
        body: JSON.stringify({ itemId, action })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok || !j.success) {
        alert("Failed: " + (j.error || r.status));
      } else {
        alert("OK: " + action + " " + itemId);
        load();
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    load();
  </script>
</body>
</html>
